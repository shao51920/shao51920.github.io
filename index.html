<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡ç½‘æ ¼è£å‰ªå·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .grid-line-h {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(255,50,50,0.9);
            cursor: row-resize;
            transform: translateY(-50%);
            transition: all 0.2s;
            z-index: 10;
        }
        .grid-line-h:hover, .grid-line-h.dragging {
            background: rgba(255,220,0,1);
            height: 4px;
            box-shadow: 0 0 8px rgba(255,220,0,0.8);
        }
        .grid-line-v {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
            background: rgba(50,150,255,0.9);
            cursor: col-resize;
            transform: translateX(-50%);
            transition: all 0.2s;
            z-index: 10;
        }
        .grid-line-v:hover, .grid-line-v.dragging {
            background: rgba(255,220,0,1);
            width: 4px;
            box-shadow: 0 0 8px rgba(255,220,0,0.8);
        }
        .result-item {
            transition: transform 0.2s;
        }
        .result-item:hover {
            transform: scale(1.05);
        }
        .grid-cell-label {
            position: absolute;
            font-size: 12px;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 2px 6px;
            border-radius: 4px;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-800 min-h-screen text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">ğŸ–¼ï¸ å›¾ç‰‡ç½‘æ ¼è£å‰ªå·¥å…·</h1>
            <p class="text-gray-300">ä¸Šä¼ å›¾ç‰‡ï¼Œè‡ªç”±è®¾ç½®è¡ŒÃ—åˆ—ç½‘æ ¼ï¼Œæ‹–åŠ¨ç½‘æ ¼çº¿è°ƒæ•´ä½ç½®ï¼Œä¸€é”®è£å‰ª</p>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒº -->
        <div class="max-w-5xl mx-auto">
            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div id="uploadArea" class="bg-white/10 backdrop-blur-md rounded-2xl p-8 mb-6 border-2 border-dashed border-white/30 hover:border-white/60 transition-all cursor-pointer text-center">
                <input type="file" id="fileInput" accept="image/*" class="hidden">
                <div class="text-6xl mb-4">ğŸ“</div>
                <p class="text-xl mb-2">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</p>
                <p class="text-gray-400 text-sm">æ”¯æŒ JPGã€PNGã€GIF ç­‰æ ¼å¼</p>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div id="controlPanel" class="hidden bg-white/10 backdrop-blur-md rounded-2xl p-6 mb-6">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex flex-wrap items-center gap-6">
                        <!-- è¡Œæ•°è®¾ç½® -->
                        <div class="flex items-center gap-2">
                            <label class="text-lg font-medium">è¡Œæ•°ï¼š</label>
                            <button id="decreaseRowBtn" class="w-10 h-10 bg-pink-500 hover:bg-pink-600 rounded-full text-xl font-bold transition-colors">âˆ’</button>
                            <span id="rowValue" class="text-3xl font-bold w-12 text-center">3</span>
                            <button id="increaseRowBtn" class="w-10 h-10 bg-pink-500 hover:bg-pink-600 rounded-full text-xl font-bold transition-colors">+</button>
                        </div>
                        <!-- åˆ—æ•°è®¾ç½® -->
                        <div class="flex items-center gap-2">
                            <label class="text-lg font-medium">åˆ—æ•°ï¼š</label>
                            <button id="decreaseColBtn" class="w-10 h-10 bg-blue-500 hover:bg-blue-600 rounded-full text-xl font-bold transition-colors">âˆ’</button>
                            <span id="colValue" class="text-3xl font-bold w-12 text-center">3</span>
                            <button id="increaseColBtn" class="w-10 h-10 bg-blue-500 hover:bg-blue-600 rounded-full text-xl font-bold transition-colors">+</button>
                        </div>
                        <span class="text-gray-300 text-lg">= <span id="totalPieces" class="font-bold text-yellow-400">9</span> å¼ </span>
                    </div>
                    <div class="flex gap-3">
                        <button id="resetGridBtn" class="px-4 py-3 bg-orange-500 hover:bg-orange-600 rounded-xl font-bold transition-all">
                            ğŸ“ é‡ç½®ç½‘æ ¼
                        </button>
                        <button id="cropBtn" class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 rounded-xl font-bold text-lg transition-all shadow-lg hover:shadow-xl">
                            âœ‚ï¸ å¼€å§‹è£å‰ª
                        </button>
                        <button id="resetBtn" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 rounded-xl font-bold transition-all">
                            ğŸ”„ é‡æ–°ä¸Šä¼ 
                        </button>
                    </div>
                </div>
                <p class="text-gray-400 text-sm mt-3">ğŸ’¡ æç¤ºï¼šæ‹–åŠ¨çº¢è‰²æ¨ªçº¿è°ƒæ•´è¡Œé«˜ï¼Œæ‹–åŠ¨è“è‰²ç«–çº¿è°ƒæ•´åˆ—å®½</p>
            </div>

            <!-- é¢„è§ˆåŒºåŸŸ -->
            <div id="previewArea" class="hidden bg-white/10 backdrop-blur-md rounded-2xl p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">ğŸ“· å›¾ç‰‡é¢„è§ˆ <span class="text-sm font-normal text-gray-400">ï¼ˆæ‹–åŠ¨ç½‘æ ¼çº¿è°ƒæ•´åˆ†å‰²ä½ç½®ï¼‰</span></h2>
                <div class="flex justify-center">
                    <div id="imageContainer" class="relative inline-block max-w-full select-none">
                        <img id="previewImage" class="max-w-full max-h-[500px] rounded-lg shadow-2xl" draggable="false">
                        <div id="gridOverlay" class="grid-overlay"></div>
                    </div>
                </div>
            </div>

            <!-- è£å‰ªç»“æœ -->
            <div id="resultArea" class="hidden bg-white/10 backdrop-blur-md rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">ğŸ¨ è£å‰ªç»“æœ</h2>
                    <button id="downloadAllBtn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg font-medium transition-colors">
                        ğŸ“¥ ä¸‹è½½å…¨éƒ¨
                    </button>
                </div>
                <div id="resultGrid" class="grid gap-4"></div>
            </div>

            <!-- è¡¨æƒ…åŒ…è½¬æ¢åŒºåŸŸ -->
            <div id="emojiArea" class="hidden bg-white/10 backdrop-blur-md rounded-2xl p-6 mt-6">
                <h2 class="text-xl font-bold mb-4">ğŸ˜Š è¡¨æƒ…åŒ…è½¬æ¢</h2>
                
                <!-- è½¬æ¢è®¾ç½® -->
                <div class="bg-white/5 rounded-xl p-4 mb-4">
                    <div class="flex flex-wrap items-center gap-6">
                        <!-- æ ¼å¼é€‰æ‹© -->
                        <div class="flex items-center gap-3">
                            <label class="font-medium">æ ¼å¼ï¼š</label>
                            <select id="emojiFormat" class="bg-white/20 text-white px-4 py-2 rounded-lg border border-white/30 focus:outline-none focus:border-white/60">
                                <option value="png">PNG (é€æ˜èƒŒæ™¯)</option>
                                <option value="gif">GIF</option>
                                <option value="webp">WebP (æ¨è)</option>
                                <option value="jpeg">JPEG</option>
                            </select>
                        </div>
                        
                        <!-- å°ºå¯¸é€‰æ‹© -->
                        <div class="flex items-center gap-3">
                            <label class="font-medium">å°ºå¯¸ï¼š</label>
                            <select id="emojiSize" class="bg-white/20 text-white px-4 py-2 rounded-lg border border-white/30 focus:outline-none focus:border-white/60">
                                <option value="64">64Ã—64 (å°)</option>
                                <option value="128" selected>128Ã—128 (æ ‡å‡†)</option>
                                <option value="240">240Ã—240 (å¾®ä¿¡)</option>
                                <option value="300">300Ã—300 (QQ)</option>
                                <option value="512">512Ã—512 (å¤§)</option>
                                <option value="custom">è‡ªå®šä¹‰</option>
                            </select>
                        </div>
                        
                        <!-- è‡ªå®šä¹‰å°ºå¯¸ -->
                        <div id="customSizeArea" class="hidden flex items-center gap-2">
                            <input type="number" id="customSize" value="200" min="16" max="1024" 
                                   class="w-20 bg-white/20 text-white px-3 py-2 rounded-lg border border-white/30 focus:outline-none focus:border-white/60">
                            <span class="text-gray-300">px</span>
                        </div>
                    </div>
                </div>

                <!-- è½¬æ¢æŒ‰é’® -->
                <div class="flex flex-wrap gap-3 mb-4 items-center">
                    <button id="convertEmojiBtn" class="px-6 py-3 bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 rounded-xl font-bold text-lg transition-all shadow-lg hover:shadow-xl">
                        ğŸ”„ æ‰¹é‡è½¬æ¢è¡¨æƒ…åŒ…
                    </button>
                    <button id="downloadEmojiAllBtn" class="hidden px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 rounded-xl font-bold transition-all">
                        ğŸ“¥ ä¸‹è½½å…¨éƒ¨è¡¨æƒ…åŒ…
                    </button>
                    <!-- è¿›åº¦æ˜¾ç¤º -->
                    <div id="progressArea" class="hidden flex items-center gap-3">
                        <div class="w-48 h-3 bg-white/20 rounded-full overflow-hidden">
                            <div id="progressBar" class="h-full bg-gradient-to-r from-green-400 to-emerald-500 transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <span id="progressText" class="text-sm text-gray-300">0/0</span>
                    </div>
                </div>
                
                <!-- è½¬æ¢ç»“æœé¢„è§ˆ -->
                <div id="emojiResultArea" class="hidden">
                    <h3 class="font-bold mb-3 text-gray-300">è½¬æ¢é¢„è§ˆï¼š</h3>
                    <div id="emojiGrid" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-3"></div>
                </div>
            </div>
        </div>

        <!-- é¡µè„š -->
        <div class="text-center mt-8 text-gray-400 text-sm">
            <p>æ‰€æœ‰å¤„ç†å‡åœ¨æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨</p>
        </div>
    </div>

    <!-- éšè—çš„ Canvas -->
    <canvas id="hiddenCanvas" class="hidden"></canvas>

    <script>
        // çŠ¶æ€å˜é‡
        let uploadedImage = null;
        let rowCount = 3;
        let colCount = 3;
        let croppedImages = [];
        
        // ç½‘æ ¼çº¿ä½ç½®ï¼ˆç™¾åˆ†æ¯”ï¼‰
        let hLinePositions = []; // æ°´å¹³çº¿ä½ç½®
        let vLinePositions = []; // å‚ç›´çº¿ä½ç½®
        
        // æ‹–åŠ¨çŠ¶æ€
        let isDragging = false;
        let dragTarget = null;
        let dragIndex = -1;

        // DOM å…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const controlPanel = document.getElementById('controlPanel');
        const previewArea = document.getElementById('previewArea');
        const previewImage = document.getElementById('previewImage');
        const imageContainer = document.getElementById('imageContainer');
        const gridOverlay = document.getElementById('gridOverlay');
        const resultArea = document.getElementById('resultArea');
        const resultGrid = document.getElementById('resultGrid');
        const rowValue = document.getElementById('rowValue');
        const colValue = document.getElementById('colValue');
        const totalPieces = document.getElementById('totalPieces');
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        const ctx = hiddenCanvas.getContext('2d');

        // ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
        uploadArea.addEventListener('click', () => fileInput.click());

        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-white', 'bg-white/20');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('border-white', 'bg-white/20');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-white', 'bg-white/20');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleFile(file);
            }
        });

        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        // å¤„ç†æ–‡ä»¶
        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImage = new Image();
                uploadedImage.onload = () => {
                    previewImage.src = e.target.result;
                    uploadArea.classList.add('hidden');
                    controlPanel.classList.remove('hidden');
                    previewArea.classList.remove('hidden');
                    resultArea.classList.add('hidden');
                    initGridPositions();
                    updateGrid();
                };
                uploadedImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // åˆå§‹åŒ–ç½‘æ ¼çº¿ä½ç½®ï¼ˆå‡åŒ€åˆ†å¸ƒï¼‰
        function initGridPositions() {
            hLinePositions = [];
            vLinePositions = [];
            
            for (let i = 1; i < rowCount; i++) {
                hLinePositions.push((i / rowCount) * 100);
            }
            for (let i = 1; i < colCount; i++) {
                vLinePositions.push((i / colCount) * 100);
            }
        }

        // è¡Œæ•°è°ƒèŠ‚æŒ‰é’®
        document.getElementById('decreaseRowBtn').addEventListener('click', () => {
            if (rowCount > 1) {
                rowCount--;
                updateDisplay();
                initGridPositions();
                updateGrid();
            }
        });

        document.getElementById('increaseRowBtn').addEventListener('click', () => {
            if (rowCount < 10) {
                rowCount++;
                updateDisplay();
                initGridPositions();
                updateGrid();
            }
        });

        // åˆ—æ•°è°ƒèŠ‚æŒ‰é’®
        document.getElementById('decreaseColBtn').addEventListener('click', () => {
            if (colCount > 1) {
                colCount--;
                updateDisplay();
                initGridPositions();
                updateGrid();
            }
        });

        document.getElementById('increaseColBtn').addEventListener('click', () => {
            if (colCount < 10) {
                colCount++;
                updateDisplay();
                initGridPositions();
                updateGrid();
            }
        });

        // é‡ç½®ç½‘æ ¼ä½ç½®
        document.getElementById('resetGridBtn').addEventListener('click', () => {
            initGridPositions();
            updateGrid();
        });

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            rowValue.textContent = rowCount;
            colValue.textContent = colCount;
            totalPieces.textContent = rowCount * colCount;
        }

        // æ›´æ–°ç½‘æ ¼çº¿
        function updateGrid() {
            gridOverlay.innerHTML = '';
            
            // æ°´å¹³çº¿
            hLinePositions.forEach((pos, index) => {
                const line = document.createElement('div');
                line.className = 'grid-line-h';
                line.style.top = `${pos}%`;
                line.dataset.index = index;
                line.dataset.type = 'h';
                line.addEventListener('mousedown', startDrag);
                line.addEventListener('touchstart', startDrag, { passive: false });
                gridOverlay.appendChild(line);
            });
            
            // å‚ç›´çº¿
            vLinePositions.forEach((pos, index) => {
                const line = document.createElement('div');
                line.className = 'grid-line-v';
                line.style.left = `${pos}%`;
                line.dataset.index = index;
                line.dataset.type = 'v';
                line.addEventListener('mousedown', startDrag);
                line.addEventListener('touchstart', startDrag, { passive: false });
                gridOverlay.appendChild(line);
            });
        }

        // å¼€å§‹æ‹–åŠ¨
        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            dragTarget = e.target;
            dragIndex = parseInt(dragTarget.dataset.index);
            dragTarget.classList.add('dragging');
            document.body.style.cursor = dragTarget.dataset.type === 'h' ? 'row-resize' : 'col-resize';
        }

        // æ‹–åŠ¨ä¸­
        function onDrag(e) {
            if (!isDragging || !dragTarget) return;
            
            const rect = imageContainer.getBoundingClientRect();
            let clientX, clientY;
            
            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            if (dragTarget.dataset.type === 'h') {
                // æ°´å¹³çº¿
                let newPos = ((clientY - rect.top) / rect.height) * 100;
                
                // é™åˆ¶èŒƒå›´
                const minPos = dragIndex === 0 ? 5 : hLinePositions[dragIndex - 1] + 5;
                const maxPos = dragIndex === hLinePositions.length - 1 ? 95 : hLinePositions[dragIndex + 1] - 5;
                newPos = Math.max(minPos, Math.min(maxPos, newPos));
                
                hLinePositions[dragIndex] = newPos;
                dragTarget.style.top = `${newPos}%`;
            } else {
                // å‚ç›´çº¿
                let newPos = ((clientX - rect.left) / rect.width) * 100;
                
                // é™åˆ¶èŒƒå›´
                const minPos = dragIndex === 0 ? 5 : vLinePositions[dragIndex - 1] + 5;
                const maxPos = dragIndex === vLinePositions.length - 1 ? 95 : vLinePositions[dragIndex + 1] - 5;
                newPos = Math.max(minPos, Math.min(maxPos, newPos));
                
                vLinePositions[dragIndex] = newPos;
                dragTarget.style.left = `${newPos}%`;
            }
        }

        // ç»“æŸæ‹–åŠ¨
        function endDrag() {
            if (isDragging && dragTarget) {
                dragTarget.classList.remove('dragging');
            }
            isDragging = false;
            dragTarget = null;
            dragIndex = -1;
            document.body.style.cursor = '';
        }

        // å…¨å±€é¼ æ ‡/è§¦æ‘¸äº‹ä»¶
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchmove', onDrag, { passive: false });
        document.addEventListener('touchend', endDrag);

        // è£å‰ªæŒ‰é’®
        document.getElementById('cropBtn').addEventListener('click', cropImage);

        // è£å‰ªå›¾ç‰‡
        function cropImage() {
            if (!uploadedImage) return;

            croppedImages = [];
            
            // æ„å»ºåˆ†å‰²ç‚¹æ•°ç»„ï¼ˆåŒ…å«0å’Œ100ï¼‰
            const hPoints = [0, ...hLinePositions, 100];
            const vPoints = [0, ...vLinePositions, 100];

            resultGrid.innerHTML = '';
            resultGrid.style.gridTemplateColumns = `repeat(${colCount}, 1fr)`;

            for (let row = 0; row < rowCount; row++) {
                for (let col = 0; col < colCount; col++) {
                    // è®¡ç®—æ¯å—çš„ä½ç½®å’Œå¤§å°ï¼ˆåŸºäºç™¾åˆ†æ¯”ï¼‰
                    const x = (vPoints[col] / 100) * uploadedImage.width;
                    const y = (hPoints[row] / 100) * uploadedImage.height;
                    const width = ((vPoints[col + 1] - vPoints[col]) / 100) * uploadedImage.width;
                    const height = ((hPoints[row + 1] - hPoints[row]) / 100) * uploadedImage.height;

                    hiddenCanvas.width = width;
                    hiddenCanvas.height = height;
                    
                    ctx.drawImage(
                        uploadedImage,
                        x, y, width, height,
                        0, 0, width, height
                    );

                    const dataUrl = hiddenCanvas.toDataURL('image/png');
                    croppedImages.push({
                        dataUrl,
                        name: `piece_${row + 1}_${col + 1}.png`
                    });

                    // åˆ›å»ºç»“æœé¡¹
                    const item = document.createElement('div');
                    item.className = 'result-item bg-white/5 rounded-lg p-2 text-center';
                    item.innerHTML = `
                        <img src="${dataUrl}" class="w-full rounded-md mb-2 cursor-pointer" 
                             onclick="downloadSingle(${croppedImages.length - 1})" 
                             title="ç‚¹å‡»ä¸‹è½½">
                        <p class="text-xs text-gray-400">${row + 1}-${col + 1}</p>
                    `;
                    resultGrid.appendChild(item);
                }
            }

            resultArea.classList.remove('hidden');
            resultArea.scrollIntoView({ behavior: 'smooth' });
        }

        // ä¸‹è½½å•å¼ 
        function downloadSingle(index) {
            const link = document.createElement('a');
            link.download = croppedImages[index].name;
            link.href = croppedImages[index].dataUrl;
            link.click();
        }

        // ä¸‹è½½å…¨éƒ¨
        document.getElementById('downloadAllBtn').addEventListener('click', () => {
            croppedImages.forEach((img, index) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.download = img.name;
                    link.href = img.dataUrl;
                    link.click();
                }, index * 200);
            });
        });

        // é‡ç½®
        document.getElementById('resetBtn').addEventListener('click', () => {
            uploadedImage = null;
            croppedImages = [];
            emojiImages = [];
            fileInput.value = '';
            uploadArea.classList.remove('hidden');
            controlPanel.classList.add('hidden');
            previewArea.classList.add('hidden');
            resultArea.classList.add('hidden');
            emojiArea.classList.add('hidden');
            rowCount = 3;
            colCount = 3;
            updateDisplay();
        });

        // ==================== è¡¨æƒ…åŒ…è½¬æ¢åŠŸèƒ½ ====================
        
        let emojiImages = [];
        const emojiArea = document.getElementById('emojiArea');
        const emojiFormat = document.getElementById('emojiFormat');
        const emojiSize = document.getElementById('emojiSize');
        const customSizeArea = document.getElementById('customSizeArea');
        const customSize = document.getElementById('customSize');
        const emojiGrid = document.getElementById('emojiGrid');
        const emojiResultArea = document.getElementById('emojiResultArea');
        const downloadEmojiAllBtn = document.getElementById('downloadEmojiAllBtn');

        // å°ºå¯¸é€‰æ‹©å˜åŒ–
        emojiSize.addEventListener('change', () => {
            if (emojiSize.value === 'custom') {
                customSizeArea.classList.remove('hidden');
            } else {
                customSizeArea.classList.add('hidden');
            }
        });

        // ä¿®æ”¹è£å‰ªå‡½æ•°ï¼Œè£å‰ªå®Œæˆåæ˜¾ç¤ºè¡¨æƒ…åŒ…åŒºåŸŸ
        const originalCropImage = cropImage;
        cropImage = function() {
            originalCropImage();
            if (croppedImages.length > 0) {
                emojiArea.classList.remove('hidden');
                emojiResultArea.classList.add('hidden');
                downloadEmojiAllBtn.classList.add('hidden');
            }
        };
        document.getElementById('cropBtn').removeEventListener('click', originalCropImage);
        document.getElementById('cropBtn').addEventListener('click', cropImage);

        // æ‰¹é‡è½¬æ¢è¡¨æƒ…åŒ…
        document.getElementById('convertEmojiBtn').addEventListener('click', convertToEmoji);

        // è¿›åº¦ç›¸å…³å…ƒç´ 
        const progressArea = document.getElementById('progressArea');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const convertEmojiBtn = document.getElementById('convertEmojiBtn');

        async function convertToEmoji() {
            if (croppedImages.length === 0) return;

            emojiImages = [];
            emojiGrid.innerHTML = '';
            
            // è·å–è®¾ç½®
            const format = emojiFormat.value;
            let size = parseInt(emojiSize.value);
            if (emojiSize.value === 'custom') {
                size = parseInt(customSize.value) || 128;
            }

            // ç¡®å®š MIME ç±»å‹
            let mimeType = 'image/png';
            let extension = 'png';
            switch (format) {
                case 'gif':
                    mimeType = 'image/gif';
                    extension = 'gif';
                    break;
                case 'webp':
                    mimeType = 'image/webp';
                    extension = 'webp';
                    break;
                case 'jpeg':
                    mimeType = 'image/jpeg';
                    extension = 'jpg';
                    break;
            }

            // æ˜¾ç¤ºè¿›åº¦
            progressArea.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = `0/${croppedImages.length}`;
            downloadEmojiAllBtn.classList.add('hidden');
            convertEmojiBtn.disabled = true;
            convertEmojiBtn.classList.add('opacity-50');

            emojiResultArea.classList.remove('hidden');

            // é€ä¸ªå¤„ç†å›¾ç‰‡
            for (let index = 0; index < croppedImages.length; index++) {
                const img = croppedImages[index];
                
                try {
                    // åˆ›å»ºæœ€ç»ˆè¡¨æƒ…åŒ…
                    await new Promise((resolve) => {
                        const tempImg = new Image();
                        tempImg.onload = () => {
                            // åˆ›å»ºæ­£æ–¹å½¢ canvas
                            hiddenCanvas.width = size;
                            hiddenCanvas.height = size;
                            
                            // æ¸…ç©ºç”»å¸ƒï¼ˆé€æ˜èƒŒæ™¯ï¼‰
                            ctx.clearRect(0, 0, size, size);
                            
                            // å¦‚æœæ˜¯ JPEGï¼Œå¡«å……ç™½è‰²èƒŒæ™¯
                            if (format === 'jpeg') {
                                ctx.fillStyle = '#ffffff';
                                ctx.fillRect(0, 0, size, size);
                            }

                            // è®¡ç®—ç¼©æ”¾å’Œå±…ä¸­
                            const srcWidth = tempImg.width;
                            const srcHeight = tempImg.height;
                            const scale = Math.min(size / srcWidth, size / srcHeight);
                            const newWidth = srcWidth * scale;
                            const newHeight = srcHeight * scale;
                            const offsetX = (size - newWidth) / 2;
                            const offsetY = (size - newHeight) / 2;

                            // ç»˜åˆ¶å›¾ç‰‡ï¼ˆä¿æŒæ¯”ä¾‹ï¼Œå±…ä¸­ï¼‰
                            ctx.drawImage(tempImg, offsetX, offsetY, newWidth, newHeight);

                            // å¯¼å‡º
                            const dataUrl = hiddenCanvas.toDataURL(mimeType);
                            emojiImages.push({
                                dataUrl,
                                name: `emoji_${index + 1}.${extension}`
                            });

                            // åˆ›å»ºé¢„è§ˆé¡¹
                            const item = document.createElement('div');
                            item.className = 'bg-white/10 rounded-lg p-2 text-center cursor-pointer hover:bg-white/20 transition-all';
                            item.style.background = 'repeating-conic-gradient(#808080 0% 25%, transparent 0% 50%) 50% / 16px 16px';
                            item.innerHTML = `
                                <img src="${dataUrl}" class="w-full rounded-md">
                                <p class="text-xs text-gray-400 mt-1">${index + 1}</p>
                            `;
                            const currentIndex = emojiImages.length - 1;
                            item.onclick = () => downloadEmojiSingle(currentIndex);
                            emojiGrid.appendChild(item);

                            resolve();
                        };
                        tempImg.src = img.dataUrl;
                    });

                    // æ›´æ–°è¿›åº¦
                    const progress = ((index + 1) / croppedImages.length) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${index + 1}/${croppedImages.length}`;

                } catch (err) {
                    console.error('å¤„ç†å›¾ç‰‡å¤±è´¥:', err);
                }
            }

            // å®Œæˆ
            downloadEmojiAllBtn.classList.remove('hidden');
            convertEmojiBtn.disabled = false;
            convertEmojiBtn.classList.remove('opacity-50');
            
            // å»¶è¿Ÿéšè—è¿›åº¦æ¡
            setTimeout(() => {
                progressArea.classList.add('hidden');
            }, 1000);
        }

        // ä¸‹è½½å•ä¸ªè¡¨æƒ…åŒ…
        function downloadEmojiSingle(index) {
            const link = document.createElement('a');
            link.download = emojiImages[index].name;
            link.href = emojiImages[index].dataUrl;
            link.click();
        }

        // ä¸‹è½½å…¨éƒ¨è¡¨æƒ…åŒ…
        downloadEmojiAllBtn.addEventListener('click', () => {
            emojiImages.forEach((img, index) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.download = img.name;
                    link.href = img.dataUrl;
                    link.click();
                }, index * 200);
            });
        });
    </script>
</body>
</html>
