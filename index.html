<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡ç½‘æ ¼è£å‰ªå·¥å…·</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='bg' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%236366f1'/><stop offset='100%25' style='stop-color:%23ec4899'/></linearGradient></defs><rect width='100' height='100' rx='15' fill='url(%23bg)'/><rect x='10' y='10' width='35' height='35' rx='5' fill='white' opacity='0.9'/><rect x='55' y='10' width='35' height='35' rx='5' fill='white' opacity='0.7'/><rect x='10' y='55' width='35' height='35' rx='5' fill='white' opacity='0.7'/><rect x='55' y='55' width='35' height='35' rx='5' fill='white' opacity='0.9'/><line x1='50' y1='5' x2='50' y2='95' stroke='%23fbbf24' stroke-width='4' stroke-linecap='round'/><line x1='5' y1='50' x2='95' y2='50' stroke='%23fbbf24' stroke-width='4' stroke-linecap='round'/></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .grid-line-h {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(255,50,50,0.9);
            cursor: row-resize;
            transform: translateY(-50%);
            transition: all 0.2s;
            z-index: 10;
        }
        .grid-line-h:hover, .grid-line-h.dragging {
            background: rgba(255,220,0,1);
            height: 4px;
            box-shadow: 0 0 8px rgba(255,220,0,0.8);
        }
        .grid-line-v {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
            background: rgba(50,150,255,0.9);
            cursor: col-resize;
            transform: translateX(-50%);
            transition: all 0.2s;
            z-index: 10;
        }
        .grid-line-v:hover, .grid-line-v.dragging {
            background: rgba(255,220,0,1);
            width: 4px;
            box-shadow: 0 0 8px rgba(255,220,0,0.8);
        }
        .result-item {
            transition: transform 0.2s;
        }
        .result-item:hover {
            transform: scale(1.05);
        }
        /* ä¿®å¤ä¸‹æ‹‰èœå•æ ·å¼ */
        select option {
            background-color: #1f2937;
            color: white;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-800 min-h-screen text-white">
    <div class="container mx-auto px-4 py-4">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-4">
            <h1 class="text-2xl font-bold mb-1">ğŸ–¼ï¸ å›¾ç‰‡ç½‘æ ¼è£å‰ªå·¥å…·</h1>
            <p class="text-gray-300 text-sm">ä¸Šä¼ å›¾ç‰‡ï¼Œè‡ªç”±è®¾ç½®è¡ŒÃ—åˆ—ç½‘æ ¼ï¼Œæ‹–åŠ¨ç½‘æ ¼çº¿è°ƒæ•´ä½ç½®ï¼Œä¸€é”®è£å‰ª</p>
        </div>

        <input type="file" id="fileInput" accept="image/*" class="hidden">

        <!-- æ§åˆ¶é¢æ¿ -->
        <div id="controlPanel" class="bg-white/10 backdrop-blur-md rounded-xl p-4 mb-4">
            <div class="flex flex-wrap items-center justify-between gap-3">
                <div class="flex flex-wrap items-center gap-4">
                    <!-- è¡Œæ•°è®¾ç½® -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium">è¡Œæ•°ï¼š</label>
                        <button id="decreaseRowBtn" class="w-8 h-8 bg-pink-500 hover:bg-pink-600 rounded-full text-lg font-bold transition-colors">âˆ’</button>
                        <span id="rowValue" class="text-2xl font-bold w-8 text-center">3</span>
                        <button id="increaseRowBtn" class="w-8 h-8 bg-pink-500 hover:bg-pink-600 rounded-full text-lg font-bold transition-colors">+</button>
                    </div>
                    <!-- åˆ—æ•°è®¾ç½® -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium">åˆ—æ•°ï¼š</label>
                        <button id="decreaseColBtn" class="w-8 h-8 bg-blue-500 hover:bg-blue-600 rounded-full text-lg font-bold transition-colors">âˆ’</button>
                        <span id="colValue" class="text-2xl font-bold w-8 text-center">3</span>
                        <button id="increaseColBtn" class="w-8 h-8 bg-blue-500 hover:bg-blue-600 rounded-full text-lg font-bold transition-colors">+</button>
                    </div>
                    <span class="text-gray-300">= <span id="totalPieces" class="font-bold text-yellow-400">9</span> å¼ </span>
                </div>
                <div class="flex gap-2">
                    <button id="reUploadBtn" class="px-3 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg font-medium text-sm transition-all">
                        ğŸ“ ä¸Šä¼ å›¾ç‰‡
                    </button>
                    <button id="resetGridBtn" class="px-3 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg font-medium text-sm transition-all">
                        ğŸ“ é‡ç½®ç½‘æ ¼
                    </button>
                    <button id="cropBtn" class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 rounded-lg font-bold transition-all shadow-lg">
                        âœ‚ï¸ å¼€å§‹è£å‰ª
                    </button>
                </div>
            </div>
            <p class="text-gray-400 text-xs mt-2">ğŸ’¡ æ‹–åŠ¨çº¢è‰²æ¨ªçº¿è°ƒæ•´è¡Œé«˜ï¼Œæ‹–åŠ¨è“è‰²ç«–çº¿è°ƒæ•´åˆ—å®½</p>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºï¼šå·¦å³å¸ƒå±€ -->
        <div id="mainContent" class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <!-- å·¦è¾¹ï¼šé¢„è§ˆåŒºåŸŸ -->
            <div id="previewArea" class="bg-white/10 backdrop-blur-md rounded-xl p-4 min-h-[400px] flex flex-col">
                <h2 class="text-lg font-bold mb-3">ğŸ“· å›¾ç‰‡é¢„è§ˆ</h2>
                <div class="flex-1 flex items-center justify-center bg-black/20 rounded-lg overflow-hidden cursor-pointer hover:bg-black/30 transition-colors" id="imageWrapper">
                    <div id="uploadPlaceholder" class="text-center p-8">
                        <div class="text-5xl mb-3 opacity-80">ğŸ“</div>
                        <p class="text-xl font-bold mb-1">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</p>
                        <p class="text-sm text-gray-400">æ”¯æŒæ‹–æ‹½ä¸Šä¼ </p>
                    </div>
                    <div id="imageContainer" class="relative inline-block max-w-full select-none hidden">
                        <img id="previewImage" class="max-w-full max-h-[400px] rounded-lg shadow-xl" draggable="false">
                        <div id="gridOverlay" class="grid-overlay"></div>
                    </div>
                </div>
            </div>

            <!-- å³è¾¹ï¼šè£å‰ªç»“æœ -->
            <div id="resultArea" class="bg-white/10 backdrop-blur-md rounded-xl p-4 min-h-[400px]">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-bold">ğŸ¨ è£å‰ªç»“æœ</h2>
                    <button id="downloadAllBtn" class="hidden px-3 py-1 bg-blue-500 hover:bg-blue-600 rounded-lg text-sm font-medium transition-colors">
                        ğŸ“¥ ä¸‹è½½å…¨éƒ¨
                    </button>
                </div>
                <div id="resultGrid" class="grid gap-2 max-h-[400px] overflow-y-auto"></div>
                <div id="resultPlaceholder" class="text-center text-gray-400 py-20 h-full flex flex-col justify-center">
                    <div>
                        <p class="text-4xl mb-2">âœ‚ï¸</p>
                        <p>ç‚¹å‡»"å¼€å§‹è£å‰ª"æŸ¥çœ‹ç»“æœ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¡¨æƒ…åŒ…è½¬æ¢åŒºåŸŸ -->
        <div id="emojiArea" class="bg-white/10 backdrop-blur-md rounded-xl p-4">
            <h2 class="text-lg font-bold mb-3">ğŸ˜Š è¡¨æƒ…åŒ…è½¬æ¢</h2>
            
            <div id="emojiPlaceholder" class="text-center text-gray-400 py-8">
                <p>âœ‚ï¸ è¯·å…ˆè£å‰ªå›¾ç‰‡</p>
            </div>

            <div id="emojiControls" class="hidden flex flex-wrap items-center gap-4 mb-4">
                <!-- æ ¼å¼é€‰æ‹© -->
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium">æ ¼å¼ï¼š</label>
                    <select id="emojiFormat" class="bg-gray-800 text-white px-3 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-blue-500">
                        <option value="png">PNG (é€æ˜èƒŒæ™¯)</option>
                        <option value="gif">GIF</option>
                        <option value="webp">WebP (æ¨è)</option>
                        <option value="jpeg">JPEG</option>
                    </select>
                </div>
                
                <!-- å°ºå¯¸é€‰æ‹© -->
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium">å°ºå¯¸ï¼š</label>
                    <select id="emojiSize" class="bg-gray-800 text-white px-3 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-blue-500">
                        <option value="128">128Ã—128 (æ ‡å‡†)</option>
                        <option value="240">240Ã—240 (å¾®ä¿¡)</option>
                        <option value="300">300Ã—300 (QQ)</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                
                <!-- è‡ªå®šä¹‰å°ºå¯¸ -->
                <div id="customSizeArea" class="hidden flex items-center gap-2">
                    <input type="number" id="customSize" value="200" min="16" max="1024" 
                           class="w-20 bg-gray-800 text-white px-3 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-blue-500">
                    <span class="text-gray-300 text-sm">px</span>
                </div>

                <!-- è½¬æ¢æŒ‰é’® -->
                <button id="convertEmojiBtn" class="px-4 py-2 bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 rounded-lg font-bold transition-all shadow-lg">
                    ğŸ”„ æ‰¹é‡è½¬æ¢
                </button>
                <button id="downloadEmojiAllBtn" class="hidden px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 rounded-lg font-bold transition-all">
                    ğŸ“¥ ä¸‹è½½å…¨éƒ¨è¡¨æƒ…åŒ…
                </button>
                
                <!-- è¿›åº¦æ˜¾ç¤º -->
                <div id="progressArea" class="hidden flex items-center gap-2">
                    <div class="w-32 h-2 bg-white/20 rounded-full overflow-hidden">
                        <div id="progressBar" class="h-full bg-gradient-to-r from-green-400 to-emerald-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="progressText" class="text-xs text-gray-300">0/0</span>
                </div>
            </div>
            
            <!-- è½¬æ¢ç»“æœé¢„è§ˆ -->
            <div id="emojiResultArea" class="hidden">
                <h3 class="font-medium mb-2 text-gray-300 text-sm">è½¬æ¢é¢„è§ˆï¼š</h3>
                <div id="emojiGrid" class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-12 gap-2"></div>
            </div>
        </div>

        <!-- é¡µè„š -->
        <div class="text-center mt-4 text-gray-400 text-xs">
            <p>æ‰€æœ‰å¤„ç†å‡åœ¨æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨</p>
            <p class="mt-1">æœ¬å·¥å…·ç”±é’é‡åˆ¶ä½œ</p>
        </div>
    </div>

    <canvas id="hiddenCanvas" class="hidden"></canvas>

    <script>
        // çŠ¶æ€å˜é‡
        let uploadedImage = null;
        let rowCount = 3;
        let colCount = 3;
        let croppedImages = [];
        let emojiImages = [];
        
        // ç½‘æ ¼çº¿ä½ç½®ï¼ˆç™¾åˆ†æ¯”ï¼‰
        let hLinePositions = [];
        let vLinePositions = [];
        
        // æ‹–åŠ¨çŠ¶æ€
        let isDragging = false;
        let dragTarget = null;
        let dragIndex = -1;

        // DOM å…ƒç´ 
        const fileInput = document.getElementById('fileInput');
        const imageWrapper = document.getElementById('imageWrapper');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const imageContainer = document.getElementById('imageContainer');
        const previewImage = document.getElementById('previewImage');
        const gridOverlay = document.getElementById('gridOverlay');
        const resultGrid = document.getElementById('resultGrid');
        const resultPlaceholder = document.getElementById('resultPlaceholder');
        const rowValue = document.getElementById('rowValue');
        const colValue = document.getElementById('colValue');
        const totalPieces = document.getElementById('totalPieces');
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        const ctx = hiddenCanvas.getContext('2d');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const emojiArea = document.getElementById('emojiArea');
        const emojiPlaceholder = document.getElementById('emojiPlaceholder');
        const emojiControls = document.getElementById('emojiControls');
        const reUploadBtn = document.getElementById('reUploadBtn');

        // é¢„è§ˆåŒºç‚¹å‡»ä¸Šä¼ 
        imageWrapper.addEventListener('click', (e) => {
            // å¦‚æœç‚¹å‡»çš„æ˜¯ç½‘æ ¼çº¿æˆ–å›¾ç‰‡æœ¬èº«ï¼Œä¸è§¦å‘ä¸Šä¼ ï¼ˆé˜²æ­¢æ‹–åŠ¨æ—¶è¯¯è§¦ï¼‰
            if (e.target.closest('.grid-line-h') || e.target.closest('.grid-line-v')) return;
            // å¦‚æœå·²ç»æœ‰å›¾ç‰‡ï¼Œä¸”ç‚¹å‡»çš„æ˜¯è¦†ç›–å±‚ï¼Œå¯èƒ½æ˜¯åœ¨æ“ä½œç½‘æ ¼ï¼Œéœ€è°¨æ…
            // è¿™é‡Œç®€å•å¤„ç†ï¼šåªæœ‰ç‚¹å‡»å ä½ç¬¦åŒºåŸŸæˆ–è€…æ˜ç¡®çš„ä¸Šä¼ æ“ä½œæ‰è§¦å‘
            // ä¸ºäº†ä½“éªŒï¼Œå¦‚æœæ²¡å›¾ç‰‡ï¼Œæ•´ä¸ªåŒºåŸŸéƒ½è§¦å‘ã€‚å¦‚æœæœ‰å›¾ç‰‡ï¼Œåªæœ‰æŒ‰é’®è§¦å‘ã€‚
            if (!uploadedImage) {
                fileInput.click();
            }
        });

        // æ‹–æ‹½ä¸Šä¼ 
        imageWrapper.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (!uploadedImage) imageWrapper.classList.add('bg-white/10');
        });

        imageWrapper.addEventListener('dragleave', () => {
            if (!uploadedImage) imageWrapper.classList.remove('bg-white/10');
        });

        imageWrapper.addEventListener('drop', (e) => {
            e.preventDefault();
            if (!uploadedImage) imageWrapper.classList.remove('bg-white/10');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleFile(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImage = new Image();
                uploadedImage.onload = () => {
                    previewImage.src = e.target.result;
                    
                    // åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
                    uploadPlaceholder.classList.add('hidden');
                    imageContainer.classList.remove('hidden');
                    resultPlaceholder.classList.remove('hidden');
                    resultGrid.innerHTML = '';
                    downloadAllBtn.classList.add('hidden');
                    
                    // é‡ç½®è¡¨æƒ…åŒ…åŒºåŸŸ
                    emojiPlaceholder.classList.remove('hidden');
                    emojiControls.classList.add('hidden');
                    document.getElementById('emojiResultArea').classList.add('hidden');
                    document.getElementById('downloadEmojiAllBtn').classList.add('hidden');

                    initGridPositions();
                    updateGrid();
                    
                    // æ›´æ–°æŒ‰é’®æ–‡å­—
                    reUploadBtn.innerHTML = 'ğŸ”„ é‡æ–°ä¸Šä¼ ';
                    reUploadBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    reUploadBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                };
                uploadedImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function initGridPositions() {
            hLinePositions = [];
            vLinePositions = [];
            for (let i = 1; i < rowCount; i++) {
                hLinePositions.push((i / rowCount) * 100);
            }
            for (let i = 1; i < colCount; i++) {
                vLinePositions.push((i / colCount) * 100);
            }
        }

        // è¡Œåˆ—è°ƒèŠ‚
        document.getElementById('decreaseRowBtn').addEventListener('click', () => {
            if (rowCount > 1) { rowCount--; updateDisplay(); initGridPositions(); updateGrid(); }
        });
        document.getElementById('increaseRowBtn').addEventListener('click', () => {
            if (rowCount < 10) { rowCount++; updateDisplay(); initGridPositions(); updateGrid(); }
        });
        document.getElementById('decreaseColBtn').addEventListener('click', () => {
            if (colCount > 1) { colCount--; updateDisplay(); initGridPositions(); updateGrid(); }
        });
        document.getElementById('increaseColBtn').addEventListener('click', () => {
            if (colCount < 10) { colCount++; updateDisplay(); initGridPositions(); updateGrid(); }
        });

        document.getElementById('resetGridBtn').addEventListener('click', () => {
            initGridPositions();
            updateGrid();
        });

        function updateDisplay() {
            rowValue.textContent = rowCount;
            colValue.textContent = colCount;
            totalPieces.textContent = rowCount * colCount;
        }

        function updateGrid() {
            gridOverlay.innerHTML = '';
            hLinePositions.forEach((pos, index) => {
                const line = document.createElement('div');
                line.className = 'grid-line-h';
                line.style.top = `${pos}%`;
                line.dataset.index = index;
                line.dataset.type = 'h';
                line.addEventListener('mousedown', startDrag);
                line.addEventListener('touchstart', startDrag, { passive: false });
                gridOverlay.appendChild(line);
            });
            vLinePositions.forEach((pos, index) => {
                const line = document.createElement('div');
                line.className = 'grid-line-v';
                line.style.left = `${pos}%`;
                line.dataset.index = index;
                line.dataset.type = 'v';
                line.addEventListener('mousedown', startDrag);
                line.addEventListener('touchstart', startDrag, { passive: false });
                gridOverlay.appendChild(line);
            });
        }

        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            dragTarget = e.target;
            dragIndex = parseInt(dragTarget.dataset.index);
            dragTarget.classList.add('dragging');
            document.body.style.cursor = dragTarget.dataset.type === 'h' ? 'row-resize' : 'col-resize';
        }

        function onDrag(e) {
            if (!isDragging || !dragTarget) return;
            const rect = imageContainer.getBoundingClientRect();
            let clientX, clientY;
            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            if (dragTarget.dataset.type === 'h') {
                let newPos = ((clientY - rect.top) / rect.height) * 100;
                const minPos = dragIndex === 0 ? 5 : hLinePositions[dragIndex - 1] + 5;
                const maxPos = dragIndex === hLinePositions.length - 1 ? 95 : hLinePositions[dragIndex + 1] - 5;
                newPos = Math.max(minPos, Math.min(maxPos, newPos));
                hLinePositions[dragIndex] = newPos;
                dragTarget.style.top = `${newPos}%`;
            } else {
                let newPos = ((clientX - rect.left) / rect.width) * 100;
                const minPos = dragIndex === 0 ? 5 : vLinePositions[dragIndex - 1] + 5;
                const maxPos = dragIndex === vLinePositions.length - 1 ? 95 : vLinePositions[dragIndex + 1] - 5;
                newPos = Math.max(minPos, Math.min(maxPos, newPos));
                vLinePositions[dragIndex] = newPos;
                dragTarget.style.left = `${newPos}%`;
            }
        }

        function endDrag() {
            if (isDragging && dragTarget) {
                dragTarget.classList.remove('dragging');
            }
            isDragging = false;
            dragTarget = null;
            dragIndex = -1;
            document.body.style.cursor = '';
        }

        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchmove', onDrag, { passive: false });
        document.addEventListener('touchend', endDrag);

        // è£å‰ª
        document.getElementById('cropBtn').addEventListener('click', cropImage);

        function cropImage() {
            if (!uploadedImage) return;
            croppedImages = [];
            const hPoints = [0, ...hLinePositions, 100];
            const vPoints = [0, ...vLinePositions, 100];

            resultGrid.innerHTML = '';
            resultGrid.style.gridTemplateColumns = `repeat(${colCount}, 1fr)`;
            resultPlaceholder.classList.add('hidden');

            for (let row = 0; row < rowCount; row++) {
                for (let col = 0; col < colCount; col++) {
                    const x = (vPoints[col] / 100) * uploadedImage.width;
                    const y = (hPoints[row] / 100) * uploadedImage.height;
                    const width = ((vPoints[col + 1] - vPoints[col]) / 100) * uploadedImage.width;
                    const height = ((hPoints[row + 1] - hPoints[row]) / 100) * uploadedImage.height;

                    hiddenCanvas.width = width;
                    hiddenCanvas.height = height;
                    ctx.drawImage(uploadedImage, x, y, width, height, 0, 0, width, height);

                    const dataUrl = hiddenCanvas.toDataURL('image/png');
                    croppedImages.push({ dataUrl, name: `piece_${row + 1}_${col + 1}.png` });

                    const item = document.createElement('div');
                    item.className = 'result-item bg-white/5 rounded-lg p-1 text-center cursor-pointer';
                    item.innerHTML = `
                        <img src="${dataUrl}" class="w-full rounded" title="ç‚¹å‡»ä¸‹è½½">
                        <p class="text-xs text-gray-400 mt-1">${row + 1}-${col + 1}</p>
                    `;
                    item.onclick = () => downloadSingle(croppedImages.length - 1);
                    resultGrid.appendChild(item);
                }
            }

            downloadAllBtn.classList.remove('hidden');
            
            // æ¿€æ´»è¡¨æƒ…åŒ…åŒºåŸŸ
            emojiPlaceholder.classList.add('hidden');
            emojiControls.classList.remove('hidden');
            document.getElementById('emojiResultArea').classList.add('hidden');
            document.getElementById('downloadEmojiAllBtn').classList.add('hidden');
        }

        function downloadSingle(index) {
            const link = document.createElement('a');
            link.download = croppedImages[index].name;
            link.href = croppedImages[index].dataUrl;
            link.click();
        }

        downloadAllBtn.addEventListener('click', () => {
            croppedImages.forEach((img, index) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.download = img.name;
                    link.href = img.dataUrl;
                    link.click();
                }, index * 200);
            });
        });

        // é‡æ–°ä¸Šä¼ æŒ‰é’®é€»è¾‘
        const reUploadBtn = document.getElementById('reUploadBtn');
        reUploadBtn.addEventListener('click', () => {
            fileInput.click();
        });



        // è¡¨æƒ…åŒ…è½¬æ¢
        const emojiFormat = document.getElementById('emojiFormat');
        const emojiSize = document.getElementById('emojiSize');
        const customSizeArea = document.getElementById('customSizeArea');
        const customSize = document.getElementById('customSize');
        const emojiGrid = document.getElementById('emojiGrid');
        const emojiResultArea = document.getElementById('emojiResultArea');
        const downloadEmojiAllBtn = document.getElementById('downloadEmojiAllBtn');
        const progressArea = document.getElementById('progressArea');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        emojiSize.addEventListener('change', () => {
            customSizeArea.classList.toggle('hidden', emojiSize.value !== 'custom');
        });

        document.getElementById('convertEmojiBtn').addEventListener('click', convertToEmoji);

        async function convertToEmoji() {
            if (croppedImages.length === 0) return;

            emojiImages = [];
            emojiGrid.innerHTML = '';
            
            const format = emojiFormat.value;
            let size = parseInt(emojiSize.value);
            if (emojiSize.value === 'custom') {
                size = parseInt(customSize.value) || 128;
            }

            let mimeType = 'image/png';
            let extension = 'png';
            switch (format) {
                case 'gif': mimeType = 'image/gif'; extension = 'gif'; break;
                case 'webp': mimeType = 'image/webp'; extension = 'webp'; break;
                case 'jpeg': mimeType = 'image/jpeg'; extension = 'jpg'; break;
            }

            progressArea.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = `0/${croppedImages.length}`;
            downloadEmojiAllBtn.classList.add('hidden');
            emojiResultArea.classList.remove('hidden');

            for (let index = 0; index < croppedImages.length; index++) {
                const img = croppedImages[index];
                
                await new Promise((resolve) => {
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        hiddenCanvas.width = size;
                        hiddenCanvas.height = size;
                        ctx.clearRect(0, 0, size, size);
                        
                        if (format === 'jpeg') {
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(0, 0, size, size);
                        }

                        const scale = Math.min(size / tempImg.width, size / tempImg.height);
                        const newWidth = tempImg.width * scale;
                        const newHeight = tempImg.height * scale;
                        const offsetX = (size - newWidth) / 2;
                        const offsetY = (size - newHeight) / 2;

                        ctx.drawImage(tempImg, offsetX, offsetY, newWidth, newHeight);

                        const dataUrl = hiddenCanvas.toDataURL(mimeType);
                        emojiImages.push({ dataUrl, name: `emoji_${index + 1}.${extension}` });

                        const item = document.createElement('div');
                        item.className = 'bg-white/10 rounded p-1 text-center cursor-pointer hover:bg-white/20 transition-all';
                        item.style.background = 'repeating-conic-gradient(#808080 0% 25%, transparent 0% 50%) 50% / 12px 12px';
                        item.innerHTML = `<img src="${dataUrl}" class="w-full rounded">`;
                        const currentIndex = emojiImages.length - 1;
                        item.onclick = () => downloadEmojiSingle(currentIndex);
                        emojiGrid.appendChild(item);

                        resolve();
                    };
                    tempImg.src = img.dataUrl;
                });

                const progress = ((index + 1) / croppedImages.length) * 100;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${index + 1}/${croppedImages.length}`;
            }

            downloadEmojiAllBtn.classList.remove('hidden');
            setTimeout(() => progressArea.classList.add('hidden'), 1000);
        }

        function downloadEmojiSingle(index) {
            const link = document.createElement('a');
            link.download = emojiImages[index].name;
            link.href = emojiImages[index].dataUrl;
            link.click();
        }

        downloadEmojiAllBtn.addEventListener('click', () => {
            emojiImages.forEach((img, index) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.download = img.name;
                    link.href = img.dataUrl;
                    link.click();
                }, index * 200);
            });
        });
    </script>
</body>
</html>
